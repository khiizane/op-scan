<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner One Piece Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #121212; color: white; margin: 0; padding: 15px; }
        #video-container { position: relative; width: 100%; max-width: 450px; margin: auto; border: 4px solid #f39c12; border-radius: 20px; overflow: hidden; background: #000; }
        video { width: 100%; display: block; }
        #overlay { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 25%; border: 2px dashed #f1c40f; pointer-events: none; }
        .controls { margin-top: 20px; }
        button { padding: 18px 30px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; background: #f39c12; color: #000; font-weight: bold; width: 80%; max-width: 300px; }
        button:disabled { background: #444; color: #888; }
        #status { margin-top: 15px; font-size: 14px; color: #bbb; }
        #result { margin-top: 15px; font-size: 22px; color: #2ecc71; font-weight: bold; min-height: 30px; }
    </style>
</head>
<body>

    <h2 style="color:#f39c12">OPCG COLLECTOR SCAN</h2>
    
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="overlay"></div>
    </div>

    <div class="controls">
        <button id="scanBtn">SCANNER LA CARTE</button>
    </div>

    <div id="result"></div>
    <p id="status">Chargement de la caméra...</p>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const scanBtn = document.getElementById('scanBtn');
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const canvas = document.getElementById('canvas');

        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfoXLM1lEmhZzIKefj4QgeB_pA6wKhdd0lKqZlF7dbxrlsX9Q1oy_qRO1WwkvDDvC-/exec"; 

        // 1. Démarrer la caméra
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } })
            .then(stream => { video.srcObject = stream; status.innerText = "Place le code (ex: OP01-001) dans le cadre."; })
            .catch(err => { status.innerText = "Erreur caméra. Vérifie les autorisations HTTPS."; });

        // 2. Fonction pour chercher le nom de la carte via une API publique
        async function fetchCardName(cardId) {
            try {
                // Utilisation de l'API Open-Source pour One Piece Card Game
                const resp = await fetch(`https://api.onepiece-cardgame.dev/cards/${cardId}`);
                if (resp.ok) {
                    const data = await resp.json();
                    return data.name;
                }
            } catch (e) { console.error("API non disponible"); }
            return "Carte Inconnue";
        }

        // 3. Logique de scan
        scanBtn.addEventListener('click', async () => {
            scanBtn.disabled = true;
            status.innerText = "Analyse de l'image...";
            resultDiv.innerText = "";

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
                
                // Nettoyage et recherche du format OPXX-XXX
                const cleanedText = text.toUpperCase().replace(/\s/g, '');
                const match = cleanedText.match(/[A-Z]{2}\d{2}-\d{3}/g);

                if (match) {
                    const cardId = match[0];
                    status.innerText = "Code trouvé : " + cardId + ". Recherche du nom...";
                    
                    const cardName = await fetchCardName(cardId);
                    resultDiv.innerText = cardName;
                    
                    await sendToSheets(cardId, cardName);
                } else {
                    status.innerText = "Code non détecté. Rapproche-toi et évite les reflets.";
                }
            } catch (error) {
                status.innerText = "Erreur OCR.";
            } finally {
                scanBtn.disabled = false;
            }
        });

        async function sendToSheets(id, name) {
            status.innerText = "Envoi au Google Sheets...";
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ id: id, nom: name })
                });
                status.innerText = "Enregistré avec succès !";
            } catch (e) {
                status.innerText = "Erreur de connexion Sheets.";
            }
        }
    </script>
</body>
</html>
