<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>op-scan V3.1</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        /* --- STYLE GLOBAL --- */
        html, body { height: 100%; margin: 0; padding: 0; background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header { background: #f39c12; color: black; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; z-index: 20; }
        
        /* VIDEO AREA */
        #video-container { position: relative; flex-grow: 1; background: black; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* CADRE DE SCAN */
        #focus-zone { position: absolute; width: 85%; height: 120px; border: 3px solid #f39c12; border-radius: 8px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); pointer-events: none; z-index: 10; }
        .scanning-line { position: absolute; width: 100%; height: 2px; background: rgba(243, 156, 18, 0.7); top: 0; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }

        /* BOUTONS & UI */
        .ui { background: #1a1a1a; padding: 15px; border-top: 2px solid #f39c12; z-index: 20; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; }
        
        button { padding: 16px; width: 100%; max-width: 400px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; margin: 5px auto; display: block; }
        .btn-scan { background: #f39c12; color: black; }
        .btn-manual { background: #333; color: #f39c12; border: 1px solid #f39c12; }
        .btn-tool { background: #444; color: white; width: auto; padding: 8px 15px; font-size: 12px; margin:0; }
        
        #status { margin-bottom: 5px; color: #f1c40f; font-weight: bold; font-size: 14px; text-align: center;}
        input[type=range] { width: 60%; accent-color: #f39c12; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; border: 2px solid #f39c12; text-align: center; }
        input[type=text] { width: 80%; padding: 15px; font-size: 20px; text-transform: uppercase; text-align: center; border-radius: 10px; border: 1px solid #f39c12; background: black; color: white; margin-bottom: 20px; }
    </style>
</head>
<body>

    <audio id="beepSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>

    <div class="header">
        <span>op-scan V3.1</span>
        <button class="btn-tool" id="flashBtn">üî¶ FLASH</button>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="focus-zone">
            <div class="scanning-line"></div>
        </div>
    </div>

    <div class="ui">
        <div id="status">Chargement cam√©ra...</div>
        <div class="controls">
            <span>ZOOM</span>
            <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1">
        </div>
        <button class="btn-scan" id="scanBtn">üì∏ SCANNER</button>
        <button class="btn-manual" onclick="showManual()">‚å®Ô∏è SAISIE MANUELLE</button>
    </div>

    <div id="modalManual" class="modal">
        <div class="modal-box">
            <h3 style="color:#f39c12">Code de la carte</h3>
            <input type="text" id="manualInput" placeholder="OP01-001">
            <button class="btn-scan" onclick="submitManual()">VALIDER</button>
            <button style="background:#e74c3c; color:white; margin-top:10px;" onclick="hideManual()">ANNULER</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
    // =================================================================
    // URL DE TON SCRIPT GOOGLE (D√©j√† int√©gr√©e)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVbW1-dcFF6Sup_cnaJsEWA2ID8FlG_ScspfYhtCmgGVDrMXc07iN-B---UR-yGgnC/exec"; 
    // =================================================================

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const status = document.getElementById('status');
    const flashBtn = document.getElementById('flashBtn');
    const zoomRange = document.getElementById('zoomRange');
    const beepSound = document.getElementById('beepSound');
    let track = null;

    // --- 1. D√âMARRAGE CAM√âRA (VERSION ROBUSTE) ---
    async function startCamera() {
        status.innerText = "D√©marrage cam√©ra...";
        
        // V√©rification de s√©curit√© (HTTPS)
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("‚ö†Ô∏è ERREUR : Impossible d'acc√©der √† la cam√©ra.\nV√©rifie que tu es bien en HTTPS (pas de http:// ou file://).");
            status.innerText = "Erreur : Non s√©curis√© (HTTPS requis)";
            return;
        }

        try {
            // On demande la cam√©ra arri√®re ("environment")
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            
            video.srcObject = stream;
            
            // On attend que la vid√©o charge pour activer les fonctions
            video.onloadedmetadata = () => {
                const tracks = stream.getVideoTracks();
                if (tracks.length > 0) {
                    track = tracks[0];
                    status.innerText = "Pr√™t √† scanner";
                } else {
                    status.innerText = "Erreur piste vid√©o";
                }
            };

        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå Cam√©ra bloqu√©e/refus√©e";
            alert("Erreur Cam√©ra : " + err.message + "\n\n1. V√©rifie les permissions.\n2. V√©rifie que le site est en HTTPS.");
        }
    }
    
    // Lancement imm√©diat
    startCamera();

    // --- 2. GESTION DU ZOOM ---
    zoomRange.oninput = () => {
        if (track) {
            try { 
                track.applyConstraints({ advanced: [{ zoom: zoomRange.value }] }); 
            } catch(e) {
                console.log("Zoom non support√©");
            }
        }
    };

    // --- 3. GESTION DU FLASH ---
    let isFlashOn = false;
    flashBtn.onclick = async () => {
        if (!track) { 
            alert("La cam√©ra n'est pas encore pr√™te !"); 
            return; 
        }
        
        try {
            isFlashOn = !isFlashOn;
            await track.applyConstraints({ advanced: [{ torch: isFlashOn }] });
            flashBtn.style.background = isFlashOn ? "#f39c12" : "#444";
        } catch (e) {
            // Si √ßa √©choue, on annule le changement d'√©tat
            isFlashOn = !isFlashOn; 
            alert("Le flash ne semble pas compatible avec ce navigateur/t√©l√©phone.");
        }
    };

    // --- 4. MODAL MANUEL ---
    function showManual() { document.getElementById('modalManual').style.display = 'flex'; }
    function hideManual() { document.getElementById('modalManual').style.display = 'none'; }

    // --- 5. ENVOI DES DONN√âES (Google Sheet) ---
    async function sendData(cardId) {
        status.innerText = "‚è≥ Envoi de " + cardId + "...";
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Indispensable pour Google Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: cardId })
            });
            // En no-cors, on ne re√ßoit pas de r√©ponse JSON, on suppose que c'est bon
            status.innerText = "‚úÖ " + cardId + " (QTE +1)";
            setTimeout(() => { status.innerText = "Pr√™t √† scanner"; }, 2000);
        } catch (e) { 
            console.error(e);
            status.innerText = "‚ùå Erreur connexion Internet"; 
        }
    }

    // --- 6. FONCTION DE SCAN INTELLIGENTE ---
    document.getElementById('scanBtn').onclick = async () => {
        if (!video.videoWidth) {
            status.innerText = "Attente cam√©ra...";
            return;
        }

        status.innerText = "üîç Analyse en cours...";
        const ctx = canvas.getContext('2d');
        
        // R√©cup√©ration dimensions r√©elles
        const w = video.videoWidth;
        const h = video.videoHeight;
        
        canvas.width = w;
        canvas.height = h;
        
        // 1. Capture image
        ctx.drawImage(video, 0, 0, w, h);

        // 2. Traitement d'image (Noir & Blanc fort)
        let imgData = ctx.getImageData(0, 0, w, h);
        let d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            // Formule luminosit√©
            let gray = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
            // Seuil de coupure (Tout ce qui est gris devient noir, le reste blanc)
            let val = (gray > 100) ? 255 : 0;
            d[i] = d[i+1] = d[i+2] = val;
        }
        ctx.putImageData(imgData, 0, 0);
        
        // 3. Reconnaissance OCR
        try {
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                tessedit_char_whitelist: 'OPSTEB0123456789-' // Liste blanche stricte
            });
            
            // 4. Nettoyage et Logique de correction
            let clean = text.toUpperCase().replace(/\s/g, '')
                            .replace(/[QD]/g, "0") // Q et D deviennent 0
                            .replace(/I/g, "1")
                            .replace(/Z/g, "2");

            // --- CORRECTIONS SP√âCIFIQUES ---
            
            // R√®gle sp√©ciale : Si √ßa commence par P suivi de 2 chiffres (ex: P09-001) -> OP09-001
            clean = clean.replace(/^P(\d{2}-)/, "OP$1");

            // Correction classique 0P -> OP
            if (clean.startsWith("0P")) clean = "OP" + clean.substring(2);
            
            // Correction O vs 0 dans les chiffres
            // On garde le pr√©fixe (2 lettres) et on force les 0 dans le reste
            if (clean.length > 4) {
                let prefix = clean.substring(0, 2);
                let suffix = clean.substring(2).replace(/O/g, "0");
                clean = prefix + suffix;
            }

            // Corrections Starters et Extra Boosters
            if (clean.startsWith("0B")) clean = "EB" + clean.substring(2);
            if (clean.startsWith("5T")) clean = "ST" + clean.substring(2);

            // 5. Validation finale (Regex)
            // Accepte : OP01-001, ST01-001, EB01-001, P-001
            let match = clean.match(/([A-Z]{1,2}\d{2}-\d{3}|P-\d{3})/);

            if (match) {
                beepSound.play();
                sendData(match[0]);
            } else {
                status.innerText = "‚ùå Code lu : " + clean.substring(0, 10);
                setTimeout(() => status.innerText = "Pr√™t √† scanner", 1500);
            }
        } catch (e) { 
            console.error(e);
            status.innerText = "Erreur OCR interne"; 
        }
    };

    function submitManual() {
        const val = document.getElementById('manualInput').value.toUpperCase();
        if (val) { hideManual(); sendData(val); }
    }
</script>
